name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-24.04-arm # linux arm64
          - ubuntu-latest    # linux x86_64
          - macos-latest     # macos arm64
          - macos-15-intel   # macos x86_64
        compiler: [ gcc, clang ]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install build tools (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config libuv1-dev

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install autoconf automake libtool pkg-config libuv

      - name: Log platform and compiler
        run: |
          CC=${{ matrix.compiler }}  
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            os_name=$(grep "^NAME=" /etc/os-release | sed -E 's/^NAME="([^"]+)"/\1/' | tr -d '"')
            os_version=$(grep "^VERSION=" /etc/os-release | sed -E 's/^VERSION="([^"]+).*/\1/' | tr -d '"')
            echo "Platform: $os_name $os_version ($(uname -m))"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            # Fix gcc on macOS (homebrew installs numbered commands like "gcc-15", while gcc is pointing to clang)
            if [[ "$CC" == "gcc" ]]; then
              CC=$(brew list gcc | grep "/bin/gcc-\d" | sort -V | tail -1 | xargs basename)
            fi
            echo "Platform: macOS $(sw_vers -productVersion) ($(uname -m))"
          fi
          echo "Compiler: $($CC --version | head -1)"
          echo "CC=$CC" >> $GITHUB_ENV

      - run: ./bootstrap

      - name: Configure build with ${{ matrix.compiler }}
        run: |
          ./configure --prefix=$HOME/local

      - name: Compile
        run: |
          export VERBOSE=1
          make

      - name: Check build
        run: src/rinetd-uv --version
